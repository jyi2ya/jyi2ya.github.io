<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><!-- hexo injector head_begin start --><script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- hexo injector head_begin end -->

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Perf ç¬”è®°ç¯å¢ƒ Linux Syameimaru-Aya 5.17.0-2-amd64 #1 SMP PREEMPT Debian 5.17.6-1 (2022-05-11) x86_64 GNU/Linuxã€‚
é…ç½®ç¯å¢ƒé¦–å…ˆå®‰è£… linux-perf è½¯ä»¶åŒ…ï¼Œè·å¾— perf(1) åº”ç”¨ç¨‹åºã€‚
æ¥">
    

    <!--Author-->
    
        <meta name="author" content="jyi2ya">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Perf ç¬”è®°"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover for sharing-->
    
        <meta property="og:image" content="https://iâ¤ï¸.ws/emoji-image/ğŸ¦„.png" />
    

    <!-- Page permalink -->
    
        <meta property="og:url" content="https://jyi2ya.github.io/2023/10/01/note/perf/main/" />
    

    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@johndoe" />
    

    <meta name="generator" content="Hexo" />

    <!-- Title -->
    
    <title>Perf ç¬”è®° - Hexo</title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


<link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body class="sans-serif">

<!-- Main Content -->
<!-- Banner -->
<!-- Banner -->
<header class="w-100 bg-1 ph5-ns ph3 text-light">

    <nav class="db w-100 mw8 center border-box pv3">
        <div class="db v-mid w-100 tc tr-ns">
            
            
        </div>
    </nav>

    <div class="w-100 tc db dt-ns">
        <!-- Title -->
        <div class="dib dtc-ns w-90-ns white">
            <h1 class="f1-ns tc tc-ns tl-ns">Perf ç¬”è®°</h1>
        </div>
        <!-- Icon -->
        <div class="dib dtc-ns w-10-ns f1 f-5-ns f-6-l mb2">
            <span class="ec">ğŸ§™</span>
        </div>
    </div>
    
</header>


<!-- Content -->
<div class="w-100 ph2 ph4-m ph5-l mv5">
    <div class="content">
        <div class="mw8 center">
            <div class="cf">
                <div class="fl w-100 mw7 left lh-copy pr4-ns pr0-m post-content">

                    <!-- Main Post Content -->
                    <h1 id="Perf-ç¬”è®°"><a href="#Perf-ç¬”è®°" class="headerlink" title="Perf ç¬”è®°"></a>Perf ç¬”è®°</h1><p>ç¯å¢ƒ <code>Linux Syameimaru-Aya 5.17.0-2-amd64 #1 SMP PREEMPT Debian 5.17.6-1 (2022-05-11) x86_64 GNU/Linux</code>ã€‚</p>
<h2 id="é…ç½®ç¯å¢ƒ"><a href="#é…ç½®ç¯å¢ƒ" class="headerlink" title="é…ç½®ç¯å¢ƒ"></a>é…ç½®ç¯å¢ƒ</h2><p>é¦–å…ˆå®‰è£… <code>linux-perf</code> è½¯ä»¶åŒ…ï¼Œè·å¾— <code>perf(1)</code> åº”ç”¨ç¨‹åºã€‚</p>
<p>æ¥ç€è¿è¡Œ <code>perf</code>ï¼Œå‘ç°æŠ¥äº†å¥‡æ€ªçš„é”™è¯¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">19:56 Syameimaru-Aya ~/sr/la/hpc/perf</span><br><span class="line">0 perf record -a ./a.out</span><br><span class="line">Error:</span><br><span class="line">Access to performance monitoring and observability operations is limited.</span><br><span class="line">Consider adjusting /proc/sys/kernel/perf_event_paranoid setting to open</span><br><span class="line">access to performance monitoring and observability operations for processes</span><br><span class="line">without CAP_PERFMON, CAP_SYS_PTRACE or CAP_SYS_ADMIN Linux capability.</span><br><span class="line">More information can be found at &#x27;Perf events and tool security&#x27; document:</span><br><span class="line">https://www.kernel.org/doc/html/latest/admin-guide/perf-security.html</span><br><span class="line">perf_event_paranoid setting is 3:</span><br><span class="line">  -1: Allow use of (almost) all events by all users</span><br><span class="line">      Ignore mlock limit after perf_event_mlock_kb without CAP_IPC_LOCK</span><br><span class="line">&gt;= 0: Disallow raw and ftrace function tracepoint access</span><br><span class="line">&gt;= 1: Disallow CPU event access</span><br><span class="line">&gt;= 2: Disallow kernel profiling</span><br><span class="line">To make the adjusted perf_event_paranoid setting permanent preserve it</span><br><span class="line">in /etc/sysctl.conf (e.g. kernel.perf_event_paranoid = &lt;setting&gt;)</span><br></pre></td></tr></table></figure>

<p>è·Ÿç€æŠ¥é”™æç¤ºé‡Œé¢æåˆ°çš„æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/admin-guide/perf-security.html">Perf events and tool security</a> çœ‹äº†ä¸€åœˆï¼Œå¤§æ¦‚çŸ¥é“é—®é¢˜å‡ºåœ¨ <code>perf</code> çš„å®‰å…¨æªæ–½ä¸Šã€‚æ–‡æ¡£é‡Œè¯´ï¼Œéšæ„ä½¿ç”¨ <code>perf</code> å¯èƒ½å…è®¸äººè·å¾—å…¶ä»–äººæ­£åœ¨è¿è¡Œçš„ç¨‹åºä¸­çš„æ•°æ®ï¼Œä¸å®‰å…¨ã€‚æˆ‘ç”¨çš„å‘è¡Œç‰ˆå°±é»˜è®¤é…ç½®æˆæ‰€æœ‰äººéƒ½ä¸èƒ½ä½¿ç”¨ <code>perf</code> äº†ã€‚</p>
<p>æ–‡æ¡£ç»™äº†ä¸€ç§å¤šç”¨æˆ·æ—¶æ§åˆ¶æƒé™ï¼Œåªè®©ç‰¹å®šçš„äººä½¿ç”¨ <code>perf</code> çš„åšæ³•ï¼šé¦–å…ˆå°† <code>/usr/bin/perf</code> ç”¨ <code>setcap(8)</code> ç¨‹åºåŠ ä¸Š <code>CAP_PERFMON</code> <code>CAP_SYS_PTRACE</code> ä¸¤ä¸ªæ ‡ç­¾ï¼Œä½¿ <code>/usr/bin/perf</code> èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨ï¼ˆæ²¡æœ‰ <code>CAP_PERFMON</code> æ ‡ç­¾çš„åº”ç”¨ç¨‹åºæ— æ³•è°ƒç”¨ <code>perf_event_open(2)</code> å‡½æ•°ï¼‰ã€‚æ¥ç€æ–°å»ºä¸ªç”¨æˆ·ç»„ï¼Œä»…ä½¿åœ¨é‚£ä¸ªç»„é‡Œçš„ç”¨æˆ·æ‹¥æœ‰ <code>/usr/bin/perf</code> çš„å¯æ‰§è¡Œæƒé™ã€‚è¿™æ ·å¯¹äºä¸€ä¸ªä¸å…è®¸ä½¿ç”¨ <code>perf</code> çš„äººæ¥è¯´ï¼Œå¤–é¢å·æ¥çš„ <code>perf</code> ä¼šå› ä¸ºæ²¡æœ‰ <code>CAP_PERFMON</code> è€Œæ— æ³•ä½¿ç”¨ï¼Œè‡ªå¸¦çš„ <code>/usr/bin/perf</code> åˆ™æ²¡æœ‰æ‰§è¡Œæƒé™ã€‚æ•´ä¸ªè®¾ç½®é¿å…äº†æœªç»è®¸å¯çš„äººä½¿ç”¨ <code>perf</code> ç¨‹åºã€‚</p>
<p>å› ä¸ºæˆ‘çš„ç¬”è®°æœ¬ç”µè„‘è‚¯å®šåªæœ‰æˆ‘ä¸€ä¸ªç”¨æˆ·ï¼Œæ‰€ä»¥æˆ‘éå¸¸æš´åŠ›åœ°æ”¹äº†ä¸€å‘ï¼Œåœ¨ <code>root</code> æƒé™ä¸‹å¾€ <code>/proc/sys/kernel/perf_event_paranoid</code> æ–‡ä»¶é‡Œå†™äº†ä¸ª <code>-1</code>ã€‚æ¥ç€åœ¨ <code>/etc/sysctl.conf</code> é‡ŒåŠ å…¥ä¸€è¡Œ <code>kernel.perf_event_paranoid = -1</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Syameimaru-Aya:~/tmp# echo -1 &gt; /proc/sys/kernel/perf_event_paranoid</span><br><span class="line">root@Syameimaru-Aya:~/tmp#</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ <code>perf</code> å°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">20:27 Syameimaru-Aya ~/sr/la/hpc/perf</span><br><span class="line">0 cat a.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main(void) &#123;</span><br><span class="line">    int i;</span><br><span class="line">    for (i = 0; i &lt; 10000000; ++i)</span><br><span class="line">        i + i;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">20:27 Syameimaru-Aya ~/sr/la/hpc/perf</span><br><span class="line">0 gcc -O0 a.c &amp;&amp; perf record -a ./a.out</span><br><span class="line">[ perf record: Woken up 1 times to write data ]</span><br><span class="line">[ perf record: Captured and wrote 0.877 MB perf.data (104 samples) ]</span><br></pre></td></tr></table></figure>

<h2 id="è·å¾—ç‚«é…·ç«ç„°å›¾"><a href="#è·å¾—ç‚«é…·ç«ç„°å›¾" class="headerlink" title="è·å¾—ç‚«é…·ç«ç„°å›¾"></a>è·å¾—ç‚«é…·ç«ç„°å›¾</h2><p>ä¸­åˆåˆç¡çš„æ—¶å€™æ¢¦åˆ°ç”Ÿæˆç«ç„°å›¾è¦ç”¨å‘½ä»¤ <code>perf script flamegraph</code>ã€‚äºæ˜¯è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°ä¸è¡Œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">20:29 Syameimaru-Aya ~/sr/la/hpc/perf</span><br><span class="line">0 perf script flamegraph</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">perf_event_attr:</span><br><span class="line">  size                             128</span><br><span class="line">  &#123; sample_period, sample_freq &#125;   4000</span><br><span class="line"></span><br><span class="line">... è¶…çº§é•¿çš„è¾“å‡º ...</span><br><span class="line"></span><br><span class="line">Flame Graph template /usr/share/d3-flame-graph/d3-flamegraph-base.html does not exist. Please install the js-d3-flame-graph (RPM) or libjs-d3-flame-graph (deb) package, specify an existing flame graph template (--template PATH) or another output format (--format FORMAT).</span><br></pre></td></tr></table></figure>

<p>å•ŠæŠ¥é”™è¯´ç¼ºå°‘åŒ… <code>libjs-d3-flame-graph</code>ã€‚å¤ªè‰¯å¿ƒäº†ï¼Œè¿ç¼ºä»€ä¹ˆåŒ…éƒ½ç»™æç¤ºå¥½ã€‚æ˜¾å¾—æˆ‘å¾ˆç¬¨çš„æ ·å­ :(ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">20:33 Syameimaru-Aya ~/sr/la/hpc/perf</span><br><span class="line">0 i libjs-d3-flame-graph</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree... Done</span><br><span class="line">Reading state information... Done</span><br><span class="line">E: Unable to locate package libjs-d3-flame-graph</span><br></pre></td></tr></table></figure>

<p>æç¤ºè¯´åŒ…ä¸å­˜åœ¨ã€‚ç”¨ <code>apt-file</code> æ‰¾äº†ä¸‹æŠ¥é”™ä¿¡æ¯ä¸­æåˆ°çš„å…³é”®æ–‡ä»¶ <code>/usr/share/d3-flame-graph/d3-flamegraph-base.html</code>ï¼Œå‘ç°æºé‡Œæ²¡æœ‰è¿™ä¸ªä¸œè¥¿ã€‚ä¸è¿‡åœ¨ <a href="pkgs.org">pkgs.org</a> ä¸Šæ‰¾äº†ä¸‹å‘ç° <code>rpm</code> çš„åŒ…åˆ°æ˜¯æœ‰â€¦â€¦æ€€ç–‘å¼€å‘éƒ½å†™æŠ¥é”™ä¿¡æ¯çš„æ—¶å€™åªæ˜¯æŠŠçº¢å¸½ç³»æ‰“åŒ…çš„å‘½åä¹ æƒ¯æ”¹æˆäº† <code>Debian</code> ç³»çš„ï¼Œä¼°è®¡æ ¹æœ¬å°±æ²¡çœ‹æœ‰æ²¡æœ‰è¿™ä¸ªåŒ…å§ï¼</p>
<p><img src="/pkgs.png" alt="æ€ä¹ˆå…¨æ˜¯ rpm åŒ…"></p>
<p>æœ€åç”¨ <code>alien(1p)</code> æŠŠ <code>rpm</code> è½¬æˆ <code>deb</code> è£…ä¸Šã€‚æˆåŠŸè¿è¡Œã€‚</p>
<p><img src="/flame-graph.png" alt="è¶…çº§é…·ç‚«çš„ç«ç„°å›¾ï¼"></p>


                    
                        <div class="pt3">
                            <span class="ec pr2">ğŸ•—</span>2023-10-01
                        </div>
                    
                    <!-- Tags Bottom -->
                    

                    <!-- Comments -->
                    

                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<footer class="bg-1 ph2 ph5-ns pv5 center tc">
    
</footer>


</body>

</html>