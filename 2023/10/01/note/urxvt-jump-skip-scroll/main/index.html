<!DOCTYPE html>
<html>
    <head><!-- hexo injector head_begin start --><script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<!-- hexo injector head_begin end -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    <title>Hexo | </title>
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/markdown.css">

    
<link rel="stylesheet" href="/css/fonts.css">

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">Hexo</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
    
        <div class="post-main-title">
            urxvt 跑得比 alacritty 还快，为什么呢？
        </div>
        <div class="post-meta">
            2023-10-01
        </div>
        <div class="post-md">
            <h1 id="urxvt-跑得比-alacritty-还快，为什么呢？"><a href="#urxvt-跑得比-alacritty-还快，为什么呢？" class="headerlink" title="urxvt 跑得比 alacritty 还快，为什么呢？"></a>urxvt 跑得比 alacritty 还快，为什么呢？</h1><h2 id="答案"><a href="#答案" class="headerlink" title="答案"></a>答案</h2><p>答案是 urxvt 并没有老老实实地绘制其内程序输出的每一个字符，而是通过一些非常取巧的方法，减少了屏幕渲染的内容数量。</p>
<p>具体来说，是用了以下两个优化：</p>
<ul>
<li>jump scroll：如果短时间内需要渲染很多行，那么 urxvt 仅会在收到的行能充满一屏时尝试刷新。</li>
<li>skip scroll：在 jump scroll 的基础上，限制刷新率为 60 Hz。</li>
</ul>
<p>开启这两个优化之后，urxvt 收到的很多内容实际上都被直接扔进历史记录里了，根本没在屏幕上出现过。同时，因为人的眼睛是非常低速的设备，所以即使这些内容没有在屏幕上出现，也不会影响使用体验。</p>
<p>如果禁用掉这些小优化，urxvt 的速度大概仅是 alacritty 的 1&#x2F;2 到 1&#x2F;3。</p>
<h2 id="alacritty-与-urxvt-的简介"><a href="#alacritty-与-urxvt-的简介" class="headerlink" title="alacritty 与 urxvt 的简介"></a>alacritty 与 urxvt 的简介</h2><p>urxvt 本身是个二十多年前的老东西，使用了很多奇怪的 X 特性。配置文件和 xterm 一样非常奇怪，可能是 Xorg 给世界留下的遗产之一……使用 C 和 C++ 编写，用 Perl 扩展。rxvt 的可扩展性很强，对标准支持也很好，各种 corner case 处理相对比较完善。</p>
<p>alacritty 是个很新的项目，号称要成为最快的终端。使用超级炒作语言 rust 开发，并且实现了 GPU 加速。他们一度声称自己是 “Fastest Terminal Emulator in Existence（现存最快终端）”。但是在 2020 年末的 <a target="_blank" rel="noopener" href="https://github.com/alacritty/alacritty/commit/3d7b16d4b0d867268c315f421904f3a2dc81a72d">一次提交</a> 中不知道为什么他们换了说法，甚至连大家炒作时最爱的 “Blazing Fast” 也干没了。可能是开发者开发地表最速终端的梦想在现实里撞车了。非常快乐，大家快去围观。总之，相比项目早期的自述，现在的自述温和了很多。</p>
<p>两个都是非常好的终端。我之前是在 Windows 下用 alacritty，在 Linux 下用 urxvt。</p>
<h2 id="为什么需要关注终端速度"><a href="#为什么需要关注终端速度" class="headerlink" title="为什么需要关注终端速度"></a>为什么需要关注终端速度</h2><p>……其实意义也不是很大，因为大家在输出内容太长的时候都会 <code>| less</code> 一下，用 pager 分页来看，终端速度对使用体验的影响很小。</p>
<p>但是既然速度是个能比的项目，那总会有人抱着一种宝可梦对决的心态来研究两个终端谁快谁慢，这也促进了这篇水帖的诞生！</p>
<h2 id="urxvt-的小优化相关代码"><a href="#urxvt-的小优化相关代码" class="headerlink" title="urxvt 的小优化相关代码"></a>urxvt 的小优化相关代码</h2><p>摘自 urxvt 代码仓库 <code>src/command.C</code> 的第 2267 行。</p>
<pre><code>if (ecb_unlikely (ch == C0_LF || str &gt;= eol))
  &#123;
    if (ch == C0_LF)
      nlines++;

    refresh_count++;

    if (!option (Opt_jumpScroll) || refresh_count &gt;= nrow - 1)
      &#123;
        refresh_count = 0;

        if (!option (Opt_skipScroll) || ev_time () &gt; ev::now () + 1. / 60.)
          &#123;
            refreshnow = true;
            ch = NOCHAR;
            break;
          &#125;
      &#125;
</code></pre>
<p>大概就是它用一堆错综复杂的条件变量实现了上面提到的小优化，整段代码唯一的注释的是这样的：</p>
<pre><code>/*
 * If there have been a lot of new lines, then update the screen
 * What the heck we&#39;ll cheat and only refresh less than every page-full.
 * if skipScroll is enabled.
 */
</code></pre>
<p>摆了。这啥 GNU-style 的神秘老代码看得我头疼……</p>

        </div>

    

</div>
                <div class="footer">
    <span>Copyright © 2022 Hexo</span>
    <span>Theme Designed By <a target="_blank" href="https://zheli.design/one-paper">這李設計</a></span>
</div>


<link rel="stylesheet" href="/css/a11y-dark.min.css">


<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
    </body>
</html>